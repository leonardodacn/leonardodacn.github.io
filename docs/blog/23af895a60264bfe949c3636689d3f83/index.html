<!DOCTYPE html>
<html lang="en" dir="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>02 服务器端的程序的编译与部署 | haokiu</title>
<meta name="keywords" content="">
<meta name="description" content="02 服务器端的程序的编译与部署 这篇我们来介绍下TeamTalk服务器端的编译与部署，部署文档在auto_setup下，这里我们只介绍下服务器程序的编译与部署，不包括管理后台的部署，其部署方法在auto_setup\im_server文件夹，其实按官方介绍只要找一台干净的linux系统运行一下auto_setup\im_server\setup.sh程序就可以了，会自动安装mysql（maridb，mysql被oracle收购后，分为两个分支，继续开源的分支改名叫maridb）、nginx和redis。我们暂且不部署web端，所以不需要安装nginx。我这里是手动安装了mysql和redis。然后启动mysql和redis，并手动建立如下库和表。库名叫teamtalk，需要建立以下这些表：
--后台管理员表 --password 密码,规则md5(md5(passwd)&#43;salt) CREATE TABLE `IMAdmin` ( `id` mediumint(6) unsigned NOT NULL AUTO_INCREMENT, `uname` varchar(40) NOT NULL COMMENT &#39;用户名&#39;, `pwd` char(32) NOT NULL COMMENT &#39;经过md5加密的密码&#39;, `status` tinyint(2) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;用户状态 0 :正常 1:删除 可扩展&#39;, `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 --存储语音地址 CREATE TABLE `IMAudio` ( `id` int(11) NOT NULL AUTO_INCREMENT, `fromId` int(11) unsigned NOT NULL COMMENT &#39;发送者Id&#39;, `toId` int(11) unsigned NOT NULL COMMENT &#39;接收者Id&#39;, `path` varchar(255) COLLATE utf8mb4_bin DEFAULT &#39;&#39; COMMENT &#39;语音存储的地址&#39;, `size` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;文件大小&#39;, `duration` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;语音时长&#39;, `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, PRIMARY KEY (`id`), KEY `idx_fromId_toId` (`fromId`,`toId`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --存储部门信息 CREATE TABLE `IMDepart` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;部门id&#39;, `departName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;部门名称&#39;, `priority` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;显示优先级,相同优先级按拼音顺序排列&#39;, `parentId` int(11) unsigned NOT NULL COMMENT &#39;上级部门id&#39;, `status` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;状态&#39;, `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_departName` (`departName`), KEY `idx_priority_status` (`priority`,`status`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --发现配置表 CREATE TABLE `IMDiscovery` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;, `itemName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;名称&#39;, `itemUrl` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;URL&#39;, `itemPriority` int(11) unsigned NOT NULL COMMENT &#39;显示优先级&#39;, `status` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;状态&#39;, `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_itemName` (`itemName`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --群组表 CREATE TABLE `IMGroup` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;群名称&#39;, `avatar` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;群头像&#39;, `creator` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建者用户id&#39;, `type` tinyint(3) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;群组类型，1-固定;2-临时群&#39;, `userCnt` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;成员人数&#39;, `status` tinyint(3) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;是否删除,0-正常，1-删除&#39;, `version` int(11) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;群版本号&#39;, `lastChated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;最后聊天时间&#39;, `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_name` (`name`(191)), KEY `idx_creator` (`creator`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT=&#39;IM群信息&#39; --群成员表 CREATE TABLE `IMGroupMember` ( `id` int(11) NOT NULL AUTO_INCREMENT, `groupId` int(11) unsigned NOT NULL COMMENT &#39;群Id&#39;, `userId` int(11) unsigned NOT NULL COMMENT &#39;用户id&#39;, `status` tinyint(4) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;是否退出群，0-正常，1-已退出&#39;, `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_groupId_userId_status` (`groupId`,`userId`,`status`), KEY `idx_userId_status_updated` (`userId`,`status`,`updated`), KEY `idx_groupId_updated` (`groupId`,`updated`) ) ENGINE=InnoDB AUTO_INCREMENT=68 DEFAULT CHARSET=utf8 COMMENT=&#39;用户和群的关系表&#39; --群消息表,x代表第几张表，目前做了分表有8张:0-7.">
<meta name="author" content="">
<link rel="canonical" href="https://haokiu.com/blog/23af895a60264bfe949c3636689d3f83/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.5cfc680b1eeaeef9efbced92d46c2a9e876b72ee14fba85846afc4cff9e6e6f8.css" integrity="sha256-XPxoCx7q7vnvvO2S1Gwqnodrcu4U&#43;6hYRq/Ez/nm5vg=" rel="preload stylesheet" as="style">
<script defer crossorigin="anonymous" src="/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js" integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG&#43;9vmJ0cTS&#43;ovo0FeA="
    onload="hljs.initHighlightingOnLoad();"></script>
<link rel="icon" href="https://haokiu.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://haokiu.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://haokiu.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://haokiu.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://haokiu.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --hljs-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
            }

            .list {
                background: var(--theme);
            }

            .list:not(.dark)::-webkit-scrollbar-track {
                background: 0 0;
            }

            .list:not(.dark)::-webkit-scrollbar-thumb {
                border-color: var(--theme);
            }
        }

    </style>
</noscript><meta property="og:title" content="02 服务器端的程序的编译与部署" />
<meta property="og:description" content="02 服务器端的程序的编译与部署 这篇我们来介绍下TeamTalk服务器端的编译与部署，部署文档在auto_setup下，这里我们只介绍下服务器程序的编译与部署，不包括管理后台的部署，其部署方法在auto_setup\im_server文件夹，其实按官方介绍只要找一台干净的linux系统运行一下auto_setup\im_server\setup.sh程序就可以了，会自动安装mysql（maridb，mysql被oracle收购后，分为两个分支，继续开源的分支改名叫maridb）、nginx和redis。我们暂且不部署web端，所以不需要安装nginx。我这里是手动安装了mysql和redis。然后启动mysql和redis，并手动建立如下库和表。库名叫teamtalk，需要建立以下这些表：
--后台管理员表 --password 密码,规则md5(md5(passwd)&#43;salt) CREATE TABLE `IMAdmin` ( `id` mediumint(6) unsigned NOT NULL AUTO_INCREMENT, `uname` varchar(40) NOT NULL COMMENT &#39;用户名&#39;, `pwd` char(32) NOT NULL COMMENT &#39;经过md5加密的密码&#39;, `status` tinyint(2) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;用户状态 0 :正常 1:删除 可扩展&#39;, `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 --存储语音地址 CREATE TABLE `IMAudio` ( `id` int(11) NOT NULL AUTO_INCREMENT, `fromId` int(11) unsigned NOT NULL COMMENT &#39;发送者Id&#39;, `toId` int(11) unsigned NOT NULL COMMENT &#39;接收者Id&#39;, `path` varchar(255) COLLATE utf8mb4_bin DEFAULT &#39;&#39; COMMENT &#39;语音存储的地址&#39;, `size` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;文件大小&#39;, `duration` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;语音时长&#39;, `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, PRIMARY KEY (`id`), KEY `idx_fromId_toId` (`fromId`,`toId`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --存储部门信息 CREATE TABLE `IMDepart` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;部门id&#39;, `departName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;部门名称&#39;, `priority` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;显示优先级,相同优先级按拼音顺序排列&#39;, `parentId` int(11) unsigned NOT NULL COMMENT &#39;上级部门id&#39;, `status` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;状态&#39;, `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_departName` (`departName`), KEY `idx_priority_status` (`priority`,`status`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --发现配置表 CREATE TABLE `IMDiscovery` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;, `itemName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;名称&#39;, `itemUrl` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;URL&#39;, `itemPriority` int(11) unsigned NOT NULL COMMENT &#39;显示优先级&#39;, `status` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;状态&#39;, `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_itemName` (`itemName`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --群组表 CREATE TABLE `IMGroup` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;群名称&#39;, `avatar` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;群头像&#39;, `creator` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建者用户id&#39;, `type` tinyint(3) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;群组类型，1-固定;2-临时群&#39;, `userCnt` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;成员人数&#39;, `status` tinyint(3) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;是否删除,0-正常，1-删除&#39;, `version` int(11) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;群版本号&#39;, `lastChated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;最后聊天时间&#39;, `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_name` (`name`(191)), KEY `idx_creator` (`creator`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT=&#39;IM群信息&#39; --群成员表 CREATE TABLE `IMGroupMember` ( `id` int(11) NOT NULL AUTO_INCREMENT, `groupId` int(11) unsigned NOT NULL COMMENT &#39;群Id&#39;, `userId` int(11) unsigned NOT NULL COMMENT &#39;用户id&#39;, `status` tinyint(4) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;是否退出群，0-正常，1-已退出&#39;, `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_groupId_userId_status` (`groupId`,`userId`,`status`), KEY `idx_userId_status_updated` (`userId`,`status`,`updated`), KEY `idx_groupId_updated` (`groupId`,`updated`) ) ENGINE=InnoDB AUTO_INCREMENT=68 DEFAULT CHARSET=utf8 COMMENT=&#39;用户和群的关系表&#39; --群消息表,x代表第几张表，目前做了分表有8张:0-7." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://haokiu.com/blog/23af895a60264bfe949c3636689d3f83/" /><meta property="article:section" content="1" />
<meta property="article:published_time" content="2021-01-11T09:20:42+00:00" />
<meta property="article:modified_time" content="2021-01-11T09:20:42+00:00" />

<meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="02 服务器端的程序的编译与部署"/>
<meta name="twitter:description" content="02 服务器端的程序的编译与部署 这篇我们来介绍下TeamTalk服务器端的编译与部署，部署文档在auto_setup下，这里我们只介绍下服务器程序的编译与部署，不包括管理后台的部署，其部署方法在auto_setup\im_server文件夹，其实按官方介绍只要找一台干净的linux系统运行一下auto_setup\im_server\setup.sh程序就可以了，会自动安装mysql（maridb，mysql被oracle收购后，分为两个分支，继续开源的分支改名叫maridb）、nginx和redis。我们暂且不部署web端，所以不需要安装nginx。我这里是手动安装了mysql和redis。然后启动mysql和redis，并手动建立如下库和表。库名叫teamtalk，需要建立以下这些表：
--后台管理员表 --password 密码,规则md5(md5(passwd)&#43;salt) CREATE TABLE `IMAdmin` ( `id` mediumint(6) unsigned NOT NULL AUTO_INCREMENT, `uname` varchar(40) NOT NULL COMMENT &#39;用户名&#39;, `pwd` char(32) NOT NULL COMMENT &#39;经过md5加密的密码&#39;, `status` tinyint(2) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;用户状态 0 :正常 1:删除 可扩展&#39;, `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 --存储语音地址 CREATE TABLE `IMAudio` ( `id` int(11) NOT NULL AUTO_INCREMENT, `fromId` int(11) unsigned NOT NULL COMMENT &#39;发送者Id&#39;, `toId` int(11) unsigned NOT NULL COMMENT &#39;接收者Id&#39;, `path` varchar(255) COLLATE utf8mb4_bin DEFAULT &#39;&#39; COMMENT &#39;语音存储的地址&#39;, `size` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;文件大小&#39;, `duration` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;语音时长&#39;, `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, PRIMARY KEY (`id`), KEY `idx_fromId_toId` (`fromId`,`toId`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --存储部门信息 CREATE TABLE `IMDepart` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;部门id&#39;, `departName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;部门名称&#39;, `priority` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;显示优先级,相同优先级按拼音顺序排列&#39;, `parentId` int(11) unsigned NOT NULL COMMENT &#39;上级部门id&#39;, `status` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;状态&#39;, `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_departName` (`departName`), KEY `idx_priority_status` (`priority`,`status`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --发现配置表 CREATE TABLE `IMDiscovery` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;, `itemName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;名称&#39;, `itemUrl` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;URL&#39;, `itemPriority` int(11) unsigned NOT NULL COMMENT &#39;显示优先级&#39;, `status` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;状态&#39;, `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_itemName` (`itemName`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --群组表 CREATE TABLE `IMGroup` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;群名称&#39;, `avatar` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;群头像&#39;, `creator` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建者用户id&#39;, `type` tinyint(3) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;群组类型，1-固定;2-临时群&#39;, `userCnt` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;成员人数&#39;, `status` tinyint(3) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;是否删除,0-正常，1-删除&#39;, `version` int(11) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;群版本号&#39;, `lastChated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;最后聊天时间&#39;, `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_name` (`name`(191)), KEY `idx_creator` (`creator`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT=&#39;IM群信息&#39; --群成员表 CREATE TABLE `IMGroupMember` ( `id` int(11) NOT NULL AUTO_INCREMENT, `groupId` int(11) unsigned NOT NULL COMMENT &#39;群Id&#39;, `userId` int(11) unsigned NOT NULL COMMENT &#39;用户id&#39;, `status` tinyint(4) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;是否退出群，0-正常，1-已退出&#39;, `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;, `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;, PRIMARY KEY (`id`), KEY `idx_groupId_userId_status` (`groupId`,`userId`,`status`), KEY `idx_userId_status_updated` (`userId`,`status`,`updated`), KEY `idx_groupId_updated` (`groupId`,`updated`) ) ENGINE=InnoDB AUTO_INCREMENT=68 DEFAULT CHARSET=utf8 COMMENT=&#39;用户和群的关系表&#39; --群消息表,x代表第几张表，目前做了分表有8张:0-7."/>


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "1s",
      "item": "https://haokiu.com/1/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "02 服务器端的程序的编译与部署",
      "item": "https://haokiu.com/blog/23af895a60264bfe949c3636689d3f83/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "02 服务器端的程序的编译与部署",
  "name": "02 服务器端的程序的编译与部署",
  "description": "02 服务器端的程序的编译与部署 这篇我们来介绍下TeamTalk服务器端的编译与部署，部署文档在auto_setup下，这里我们只介绍下服务器程序的编译与部署，不包括管理后台的部署，其部署方法在auto_setup\\im_server文件夹，其实按官方介绍只要找一台干净的linux系统运行一下auto_setup\\im_server\\setup.sh程序就可以了，会自动安装mysql（maridb，mysql被oracle收购后，分为两个分支，继续开源的分支改名叫maridb）、nginx和redis。我们暂且不部署web端，所以不需要安装nginx。我这里是手动安装了mysql和redis。然后启动mysql和redis，并手动建立如下库和表。库名叫teamtalk，需要建立以下这些表：\n--后台管理员表 --password 密码,规则md5(md5(passwd)+salt) CREATE TABLE `IMAdmin` ( `id` mediumint(6) unsigned NOT NULL AUTO_INCREMENT, `uname` varchar(40) NOT NULL COMMENT \u0026#39;用户名\u0026#39;, `pwd` char(32) NOT NULL COMMENT \u0026#39;经过md5加密的密码\u0026#39;, `status` tinyint(2) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;用户状态 0 :正常 1:删除 可扩展\u0026#39;, `created` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;创建时间\u0026#39;, `updated` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;更新时间\u0026#39;, PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 --存储语音地址 CREATE TABLE `IMAudio` ( `id` int(11) NOT NULL AUTO_INCREMENT, `fromId` int(11) unsigned NOT NULL COMMENT \u0026#39;发送者Id\u0026#39;, `toId` int(11) unsigned NOT NULL COMMENT \u0026#39;接收者Id\u0026#39;, `path` varchar(255) COLLATE utf8mb4_bin DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;语音存储的地址\u0026#39;, `size` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;文件大小\u0026#39;, `duration` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;语音时长\u0026#39;, `created` int(11) unsigned NOT NULL COMMENT \u0026#39;创建时间\u0026#39;, PRIMARY KEY (`id`), KEY `idx_fromId_toId` (`fromId`,`toId`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --存储部门信息 CREATE TABLE `IMDepart` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT \u0026#39;部门id\u0026#39;, `departName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;部门名称\u0026#39;, `priority` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;显示优先级,相同优先级按拼音顺序排列\u0026#39;, `parentId` int(11) unsigned NOT NULL COMMENT \u0026#39;上级部门id\u0026#39;, `status` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;状态\u0026#39;, `created` int(11) unsigned NOT NULL COMMENT \u0026#39;创建时间\u0026#39;, `updated` int(11) unsigned NOT NULL COMMENT \u0026#39;更新时间\u0026#39;, PRIMARY KEY (`id`), KEY `idx_departName` (`departName`), KEY `idx_priority_status` (`priority`,`status`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --发现配置表 CREATE TABLE `IMDiscovery` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT \u0026#39;id\u0026#39;, `itemName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;名称\u0026#39;, `itemUrl` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;URL\u0026#39;, `itemPriority` int(11) unsigned NOT NULL COMMENT \u0026#39;显示优先级\u0026#39;, `status` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;状态\u0026#39;, `created` int(11) unsigned NOT NULL COMMENT \u0026#39;创建时间\u0026#39;, `updated` int(11) unsigned NOT NULL COMMENT \u0026#39;更新时间\u0026#39;, PRIMARY KEY (`id`), KEY `idx_itemName` (`itemName`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --群组表 CREATE TABLE `IMGroup` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;群名称\u0026#39;, `avatar` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT \u0026#39;\u0026#39; COMMENT \u0026#39;群头像\u0026#39;, `creator` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;创建者用户id\u0026#39;, `type` tinyint(3) unsigned NOT NULL DEFAULT \u0026#39;1\u0026#39; COMMENT \u0026#39;群组类型，1-固定;2-临时群\u0026#39;, `userCnt` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;成员人数\u0026#39;, `status` tinyint(3) unsigned NOT NULL DEFAULT \u0026#39;1\u0026#39; COMMENT \u0026#39;是否删除,0-正常，1-删除\u0026#39;, `version` int(11) unsigned NOT NULL DEFAULT \u0026#39;1\u0026#39; COMMENT \u0026#39;群版本号\u0026#39;, `lastChated` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;最后聊天时间\u0026#39;, `created` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;创建时间\u0026#39;, `updated` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;更新时间\u0026#39;, PRIMARY KEY (`id`), KEY `idx_name` (`name`(191)), KEY `idx_creator` (`creator`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT=\u0026#39;IM群信息\u0026#39; --群成员表 CREATE TABLE `IMGroupMember` ( `id` int(11) NOT NULL AUTO_INCREMENT, `groupId` int(11) unsigned NOT NULL COMMENT \u0026#39;群Id\u0026#39;, `userId` int(11) unsigned NOT NULL COMMENT \u0026#39;用户id\u0026#39;, `status` tinyint(4) unsigned NOT NULL DEFAULT \u0026#39;1\u0026#39; COMMENT \u0026#39;是否退出群，0-正常，1-已退出\u0026#39;, `created` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;创建时间\u0026#39;, `updated` int(11) unsigned NOT NULL DEFAULT \u0026#39;0\u0026#39; COMMENT \u0026#39;更新时间\u0026#39;, PRIMARY KEY (`id`), KEY `idx_groupId_userId_status` (`groupId`,`userId`,`status`), KEY `idx_userId_status_updated` (`userId`,`status`,`updated`), KEY `idx_groupId_updated` (`groupId`,`updated`) ) ENGINE=InnoDB AUTO_INCREMENT=68 DEFAULT CHARSET=utf8 COMMENT=\u0026#39;用户和群的关系表\u0026#39; --群消息表,x代表第几张表，目前做了分表有8张:0-7.",
  "keywords": [
    
  ],
  "articleBody": "02 服务器端的程序的编译与部署 这篇我们来介绍下TeamTalk服务器端的编译与部署，部署文档在auto_setup下，这里我们只介绍下服务器程序的编译与部署，不包括管理后台的部署，其部署方法在auto_setup\\im_server文件夹，其实按官方介绍只要找一台干净的linux系统运行一下auto_setup\\im_server\\setup.sh程序就可以了，会自动安装mysql（maridb，mysql被oracle收购后，分为两个分支，继续开源的分支改名叫maridb）、nginx和redis。我们暂且不部署web端，所以不需要安装nginx。我这里是手动安装了mysql和redis。然后启动mysql和redis，并手动建立如下库和表。库名叫teamtalk，需要建立以下这些表：\n--后台管理员表 --password 密码,规则md5(md5(passwd)+salt) CREATE TABLE `IMAdmin` ( `id` mediumint(6) unsigned NOT NULL AUTO_INCREMENT, `uname` varchar(40) NOT NULL COMMENT '用户名', `pwd` char(32) NOT NULL COMMENT '经过md5加密的密码', `status` tinyint(2) unsigned NOT NULL DEFAULT '0' COMMENT '用户状态 0 :正常 1:删除 可扩展', `created` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '创建时间', `updated` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '更新时间', PRIMARY KEY (`id`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 --存储语音地址 CREATE TABLE `IMAudio` ( `id` int(11) NOT NULL AUTO_INCREMENT, `fromId` int(11) unsigned NOT NULL COMMENT '发送者Id', `toId` int(11) unsigned NOT NULL COMMENT '接收者Id', `path` varchar(255) COLLATE utf8mb4_bin DEFAULT '' COMMENT '语音存储的地址', `size` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '文件大小', `duration` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '语音时长', `created` int(11) unsigned NOT NULL COMMENT '创建时间', PRIMARY KEY (`id`), KEY `idx_fromId_toId` (`fromId`,`toId`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --存储部门信息 CREATE TABLE `IMDepart` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '部门id', `departName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '部门名称', `priority` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '显示优先级,相同优先级按拼音顺序排列', `parentId` int(11) unsigned NOT NULL COMMENT '上级部门id', `status` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '状态', `created` int(11) unsigned NOT NULL COMMENT '创建时间', `updated` int(11) unsigned NOT NULL COMMENT '更新时间', PRIMARY KEY (`id`), KEY `idx_departName` (`departName`), KEY `idx_priority_status` (`priority`,`status`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --发现配置表 CREATE TABLE `IMDiscovery` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id', `itemName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '名称', `itemUrl` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT 'URL', `itemPriority` int(11) unsigned NOT NULL COMMENT '显示优先级', `status` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '状态', `created` int(11) unsigned NOT NULL COMMENT '创建时间', `updated` int(11) unsigned NOT NULL COMMENT '更新时间', PRIMARY KEY (`id`), KEY `idx_itemName` (`itemName`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --群组表 CREATE TABLE `IMGroup` ( `id` int(11) NOT NULL AUTO_INCREMENT, `name` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '群名称', `avatar` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '群头像', `creator` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '创建者用户id', `type` tinyint(3) unsigned NOT NULL DEFAULT '1' COMMENT '群组类型，1-固定;2-临时群', `userCnt` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '成员人数', `status` tinyint(3) unsigned NOT NULL DEFAULT '1' COMMENT '是否删除,0-正常，1-删除', `version` int(11) unsigned NOT NULL DEFAULT '1' COMMENT '群版本号', `lastChated` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '最后聊天时间', `created` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '创建时间', `updated` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '更新时间', PRIMARY KEY (`id`), KEY `idx_name` (`name`(191)), KEY `idx_creator` (`creator`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='IM群信息' --群成员表 CREATE TABLE `IMGroupMember` ( `id` int(11) NOT NULL AUTO_INCREMENT, `groupId` int(11) unsigned NOT NULL COMMENT '群Id', `userId` int(11) unsigned NOT NULL COMMENT '用户id', `status` tinyint(4) unsigned NOT NULL DEFAULT '1' COMMENT '是否退出群，0-正常，1-已退出', `created` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '创建时间', `updated` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '更新时间', PRIMARY KEY (`id`), KEY `idx_groupId_userId_status` (`groupId`,`userId`,`status`), KEY `idx_userId_status_updated` (`userId`,`status`,`updated`), KEY `idx_groupId_updated` (`groupId`,`updated`) ) ENGINE=InnoDB AUTO_INCREMENT=68 DEFAULT CHARSET=utf8 COMMENT='用户和群的关系表' --群消息表,x代表第几张表，目前做了分表有8张:0-7.消息具体在哪张表中，是groupId%IMGroupMessage表的数目 CREATE TABLE `IMGroupMessage_(x)` ( `id` int(11) NOT NULL AUTO_INCREMENT, `groupId` int(11) unsigned NOT NULL COMMENT '用户的关系id', `userId` int(11) unsigned NOT NULL COMMENT '发送用户的id', `msgId` int(11) unsigned NOT NULL COMMENT '消息ID', `content` varchar(4096) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '消息内容', `type` tinyint(3) unsigned NOT NULL DEFAULT '2' COMMENT '群消息类型,101为群语音,2为文本', `status` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '消息状态', `created` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '创建时间', `updated` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '更新时间', PRIMARY KEY (`id`), KEY `idx_groupId_status_created` (`groupId`,`status`,`created`), KEY `idx_groupId_msgId_status_created` (`groupId`,`msgId`,`status`,`created`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT='IM群消息表' --消息表，x代表第几张表，目前做了分表有8张:0-7.具体在那张表，是relateId%IMMessage表数目. CREATE TABLE `IMMessage_0` ( `id` int(11) NOT NULL AUTO_INCREMENT, `relateId` int(11) unsigned NOT NULL COMMENT '用户的关系id', `fromId` int(11) unsigned NOT NULL COMMENT '发送用户的id', `toId` int(11) unsigned NOT NULL COMMENT '接收用户的id', `msgId` int(11) unsigned NOT NULL COMMENT '消息ID', `content` varchar(4096) COLLATE utf8mb4_bin DEFAULT '' COMMENT '消息内容', `type` tinyint(2) unsigned NOT NULL DEFAULT '1' COMMENT '消息类型', `status` tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '0正常 1被删除', `created` int(11) unsigned NOT NULL COMMENT '创建时间', `updated` int(11) unsigned NOT NULL COMMENT '更新时间', PRIMARY KEY (`id`), KEY `idx_relateId_status_created` (`relateId`,`status`,`created`), KEY `idx_relateId_status_msgId_created` (`relateId`,`status`,`msgId`,`created`), KEY `idx_fromId_toId_created` (`fromId`,`toId`,`status`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --最近联系人(会话)表。 CREATE TABLE `IMRecentSession` ( `id` int(11) NOT NULL AUTO_INCREMENT, `userId` int(11) unsigned NOT NULL COMMENT '用户id', `peerId` int(11) unsigned NOT NULL COMMENT '对方id', `type` tinyint(1) unsigned DEFAULT '0' COMMENT '类型，1-用户,2-群组', `status` tinyint(1) unsigned DEFAULT '0' COMMENT '用户:0-正常, 1-用户A删除,群组:0-正常, 1-被删除', `created` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '创建时间', `updated` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '更新时间', PRIMARY KEY (`id`), KEY `idx_userId_peerId_status_updated` (`userId`,`peerId`,`status`,`updated`), KEY `idx_userId_peerId_type` (`userId`,`peerId`,`type`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 --用户关系表，标识两个用户之间的唯一关系id，用于消息分表。relationId % 消息表数目。 CREATE TABLE `IMRelationShip` ( `id` int(11) NOT NULL AUTO_INCREMENT, `smallId` int(11) unsigned NOT NULL COMMENT '用户A的id', `bigId` int(11) unsigned NOT NULL COMMENT '用户B的id', `status` tinyint(1) unsigned DEFAULT '0' COMMENT '用户:0-正常, 1-用户A删除,群组:0-正常, 1-被删除', `created` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '创建时间', `updated` int(11) unsigned NOT NULL DEFAULT '0' COMMENT '更新时间', PRIMARY KEY (`id`), KEY `idx_smallId_bigId_status_updated` (`smallId`,`bigId`,`status`,`updated`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8 --用户表 --password 密码,规则md5(md5(passwd)+salt) CREATE TABLE `IMUser` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT '用户id', `sex` tinyint(1) unsigned NOT NULL DEFAULT '0' COMMENT '1男2女0未知', `name` varchar(32) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '用户名', `domain` varchar(32) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '拼音', `nick` varchar(32) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '花名,绰号等', `password` varchar(32) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '密码', `salt` varchar(4) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '混淆码', `phone` varchar(11) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '手机号码', `email` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT 'email', `avatar` varchar(255) COLLATE utf8mb4_bin DEFAULT '' COMMENT '自定义用户头像', `departId` int(11) unsigned NOT NULL COMMENT '所属部门Id', `status` tinyint(2) unsigned DEFAULT '0' COMMENT '1. 试用期 2. 正式 3. 离职 4.实习', `sign_info` varchar(32) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '个性签名', `created` int(11) unsigned NOT NULL COMMENT '创建时间', `updated` int(11) unsigned NOT NULL COMMENT '更新时间', PRIMARY KEY (`id`), KEY `idx_domain` (`domain`), KEY `idx_name` (`name`), KEY `idx_phone` (`phone`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin --离线文件传输表（同事建议的，待考证） CREATE TABLE `IMTransmitFile` ( `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT 'id', `fromId` int(11) unsigned NOT NULL COMMENT '发送用户的id', `toId` int(11) unsigned NOT NULL COMMENT '接收用户的id', `fileName` varchar(32) COLLATE utf8mb4_bin DEFAULT '' COMMENT '文件名字', `size` int(11) unsigned NOT NULL COMMENT '文件大小', `taskId` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT '' COMMENT '任务id', `status` tinyint(1) unsigned DEFAULT '0' COMMENT '状态', `created` int(11) unsigned NOT NULL COMMENT '创建时间', `updated` int(11) unsigned NOT NULL COMMENT '更新时间', PRIMARY KEY (`id`), KEY `idx_taskId` (`taskId`) ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin; 因为这个企业内部的即时通讯软件，所以客户端不提供注册功能，要想增加新用户，必须通过在管理后台界面手动添加，这里由于我们目前没有部署管理后台界面（需要先安装nginx），所以我们就直接先在用户表IMUser里面添加几个测试用户吧。这个就是基本的sql语句了。但是由于这里用户密码的生成规则是：md5(md5(passwd)+salt)，而我们不知道salt到底是什么，这个现在不急，我们后面分析服务器代码时会介绍它。所以，我们就暂且在数据库里面随便写的密码，然后在程序里面修改代码，暂且不校验密码。修改的地方在这里：server\\src\\db_proxy_server\\business\\InterLogin.cpp的51行（CInterLoginStrategy::doLogin函数里面），将这个if语句注释掉：\n接下来就是如何编译程序了：\n编译程序需要用到cmake和make、gcc，由于程序用了部分C++11的东西，所以gcc的版本至少在4.7以上，我的部署环境是CentOS7、cmake 2.8，gcc 4.8.5。\n编译方法：\n编译说明 编译环境 TeamTalk编译需要依赖一些最新的c++标准, 建议使用CentOS 7.0, 如果使用的是CentOS 6.x,需要将g++版本升至支持c++11特性,升级脚本可以使用自动安装脚本目录下的gcc_setup\n第三方库 TeamTalk使用了许多第三方库，包括protobuf,hiredis,mariadb(mysql),log4cxx等等,在第一次编译TeamTalk之前,建议先执行目录下的：\nprotobuf: make_protobuf.sh hiredis: make_hiredis.sh mariadb: make_mariadb.sh log4cxx: make_log4cxx.sh 这些脚本执行完后会自动将头文件和库文件拷贝至指定的目录。如果你的机器上已经安装了相应的模块，可以不用执行相对应的脚本。\nmake_protobuf.sh会做以下工作：\n解压和编译protobuf目录下的protobuf-2.6.1.tar.gz文件，并在将编译后的文件拷贝到该目录，分别是bin、include和lib，还有一个protobuf-2.6.1是解压后的目录。protobuf目录结构如下：\n. |-- bin |-- include |-- lib |-- protobuf-2.6.1 `-- protobuf-2.6.1.tar.gz 同时会往server/src/base/pb目录下拷贝google和lib两个文件夹，protocol是原来就存在的存放protobuf的*.proto文件的目录，目录结构如下：\n. |-- google |-- lib `-- protocol make_log4cxx.sh 会做以下工作：\n\\1. 从网址 http://mirror.bit.edu.cn/apache/logging/log4cxx/0.10.0/apache-log4cxx-0.10.0.tar.gz 下载apache-log4cxx-0.10.0.tar.gz文件。下载好后解压安装，并在log4\ncxx目录下生成lib和include两个文件夹，目录结构如下：\n. |-- apache-log4cxx-0.10.0 |-- apache-log4cxx-0.10.0.tar.gz |-- console.cpp |-- include |-- inputstreamreader.cpp |-- lib `-- socketoutputstream.cpp 同样，apache-log4cxx-0.10.0是解压后的目录。\nmake_hiredis.sh和make_mariadb.sh原理一样，这里就不介绍了。\n编译TeamTalk服务器 当以上步骤都完成后，可以使用\"./build.sh version 1\"编译整个TeamTalk工程,一旦编译完成，会在上级目录生成im_server_x.tar.gz包，该压缩包包含的内容有: sync_lib_for_zip.sh: 将lib目录下的依赖库copy至各个服务器的目录下，启动服务前需要先执行一次该脚本 lib: 主要包含各个服务器依赖的第三方库 restart.sh: 启动脚本，启动方式为./restart.sh msg_server\nlogin_server: msg_server: route_server: db_proxy_server: file_server: push_server: msfs: 也可以进入各个服务目录下手动使用cmake . \u0026\u0026 make去逐个编译。每个程序都有个配置文件，配置文件在auto_setup\\im_server\\conf目录下，手动编译时，请考到与与对应服务相同的目录下。\n注意最终生成的可执行文件，其配置文件必须和他们在同一个目录。另外可执行程序需要一个log4cxx.properties文件，这个文件是程序使用的日志库log4\ncxx的配置文件，必须也和可执行程序在同一个目录。如果没有，程序仍然能运行，但可能不能正常工作。你可以将\\server\\src\\slog\\log4cxx.properties下的该文件拷贝过去。\n生成程序后，你需要启动以上服务，当然在这前提下你必须能正常连接你的mysql和redis。可以按下列顺序启动服务：\ndb_proxy_server file_server msfs route_server http_server login_server msg_server 程序启动以后用lsof -i -Pn命令查看端口和连接情况：\nmysqld 2970 mysql 18u IPv6 26929 0t0 TCP *:3306 (LISTEN) mysqld 2970 mysql 40u IPv6 2347264 0t0 TCP 127.0.0.1:3306-\u003e127.0.0.1:34780 (ESTABLISHED) mysqld 2970 mysql 41u IPv6 2347266 0t0 TCP 127.0.0.1:3306-\u003e127.0.0.1:34782 (ESTABLISHED) mysqld 2970 mysql 42u IPv6 31596 0t0 TCP 127.0.0.1:3306-\u003e127.0.0.1:33954 (ESTABLISHED) mysqld 2970 mysql 43u IPv6 31598 0t0 TCP 127.0.0.1:3306-\u003e127.0.0.1:33956 (ESTABLISHED) mysqld 2970 mysql 50u IPv6 61604 0t0 TCP 127.0.0.1:3306-\u003e127.0.0.1:34638 (ESTABLISHED) mysqld 2970 mysql 51u IPv6 108460 0t0 TCP 127.0.0.1:3306-\u003e127.0.0.1:37204 (ESTABLISHED) redis-server 3772 zhangyl 4u IPv6 30711 0t0 TCP *:6379 (LISTEN) redis-server 3772 zhangyl 5u IPv4 30712 0t0 TCP *:6379 (LISTEN) redis-server 3772 zhangyl 6u IPv4 31560 0t0 TCP 127.0.0.1:6379-\u003e127.0.0.1:39540 (ESTABLISHED) redis-server 3772 zhangyl 7u IPv4 31563 0t0 TCP 127.0.0.1:6379-\u003e127.0.0.1:39542 (ESTABLISHED) redis-server 3772 zhangyl 8u IPv4 31566 0t0 TCP 127.0.0.1:6379-\u003e127.0.0.1:39544 (ESTABLISHED) redis-server 3772 zhangyl 9u IPv4 31569 0t0 TCP 127.0.0.1:6379-\u003e127.0.0.1:39546 (ESTABLISHED) redis-server 3772 zhangyl 10u IPv4 31572 0t0 TCP 127.0.0.1:6379-\u003e127.0.0.1:39548 (ESTABLISHED) redis-server 3772 zhangyl 11u IPv4 31575 0t0 TCP 127.0.0.1:6379-\u003e127.0.0.1:39550 (ESTABLISHED) redis-server 3772 zhangyl 12u IPv4 31578 0t0 TCP 127.0.0.1:6379-\u003e127.0.0.1:39552 (ESTABLISHED) redis-server 3772 zhangyl 13u IPv4 31581 0t0 TCP 127.0.0.1:6379-\u003e127.0.0.1:39554 (ESTABLISHED) redis-server 3772 zhangyl 14u IPv4 31584 0t0 TCP 127.0.0.1:6379-\u003e127.0.0.1:39556 (ESTABLISHED) redis-server 3772 zhangyl 15u IPv4 31587 0t0 TCP 127.0.0.1:6379-\u003e127.0.0.1:39558 (ESTABLISHED) db_proxy_server 3930 root 5u IPv4 31559 0t0 TCP 127.0.0.1:39540-\u003e127.0.0.1:6379 (ESTABLISHED) db_proxy_server 3930 root 6u IPv4 31562 0t0 TCP 127.0.0.1:39542-\u003e127.0.0.1:6379 (ESTABLISHED) db_proxy_server 3930 root 7u IPv4 31565 0t0 TCP 127.0.0.1:39544-\u003e127.0.0.1:6379 (ESTABLISHED) db_proxy_server 3930 root 8u IPv4 31568 0t0 TCP 127.0.0.1:39546-\u003e127.0.0.1:6379 (ESTABLISHED) db_proxy_server 3930 root 9u IPv4 31571 0t0 TCP 127.0.0.1:39548-\u003e127.0.0.1:6379 (ESTABLISHED) db_proxy_server 3930 root 10u IPv4 31574 0t0 TCP 127.0.0.1:39550-\u003e127.0.0.1:6379 (ESTABLISHED) db_proxy_server 3930 root 11u IPv4 31577 0t0 TCP 127.0.0.1:39552-\u003e127.0.0.1:6379 (ESTABLISHED) db_proxy_server 3930 root 12u IPv4 31580 0t0 TCP 127.0.0.1:39554-\u003e127.0.0.1:6379 (ESTABLISHED) db_proxy_server 3930 root 13u IPv4 31583 0t0 TCP 127.0.0.1:39556-\u003e127.0.0.1:6379 (ESTABLISHED) db_proxy_server 3930 root 14u IPv4 31586 0t0 TCP 127.0.0.1:39558-\u003e127.0.0.1:6379 (ESTABLISHED) db_proxy_server 3930 root 15u IPv4 2347263 0t0 TCP 127.0.0.1:34780-\u003e127.0.0.1:3306 (ESTABLISHED) db_proxy_server 3930 root 16u IPv4 2347265 0t0 TCP 127.0.0.1:34782-\u003e127.0.0.1:3306 (ESTABLISHED) db_proxy_server 3930 root 17u IPv4 31595 0t0 TCP 127.0.0.1:33954-\u003e127.0.0.1:3306 (ESTABLISHED) db_proxy_server 3930 root 18u IPv4 31597 0t0 TCP 127.0.0.1:33956-\u003e127.0.0.1:3306 (ESTABLISHED) db_proxy_server 3930 root 20u IPv4 31599 0t0 TCP *:10600 (LISTEN) db_proxy_server 3930 root 21u IPv4 2344452 0t0 TCP 127.0.0.1:10600-\u003e127.0.0.1:41630 (ESTABLISHED) db_proxy_server 3930 root 22u IPv4 2344453 0t0 TCP 127.0.0.1:10600-\u003e127.0.0.1:41632 (ESTABLISHED) db_proxy_server 3930 root 23u IPv4 2344454 0t0 TCP 127.0.0.1:10600-\u003e127.0.0.1:41640 (ESTABLISHED) db_proxy_server 3930 root 24u IPv4 2344455 0t0 TCP 127.0.0.1:10600-\u003e127.0.0.1:41642 (ESTABLISHED) db_proxy_server 3930 root 25u IPv4 2344456 0t0 TCP 127.0.0.1:10600-\u003e127.0.0.1:41644 (ESTABLISHED) db_proxy_server 3930 root 26u IPv4 2344457 0t0 TCP 127.0.0.1:10600-\u003e127.0.0.1:41646 (ESTABLISHED) db_proxy_server 3930 root 27u IPv4 2344458 0t0 TCP 127.0.0.1:10600-\u003e127.0.0.1:41648 (ESTABLISHED) db_proxy_server 3930 root 28u IPv4 2344459 0t0 TCP 127.0.0.1:10600-\u003e127.0.0.1:41650 (ESTABLISHED) db_proxy_server 3930 root 29u IPv4 2344460 0t0 TCP 127.0.0.1:10600-\u003e127.0.0.1:41652 (ESTABLISHED) db_proxy_server 3930 root 30u IPv4 2344461 0t0 TCP 127.0.0.1:10600-\u003e127.0.0.1:41654 (ESTABLISHED) db_proxy_server 3930 root 31u IPv4 61603 0t0 TCP 127.0.0.1:34638-\u003e127.0.0.1:3306 (ESTABLISHED) db_proxy_server 3930 root 32u IPv4 108459 0t0 TCP 127.0.0.1:37204-\u003e127.0.0.1:3306 (ESTABLISHED) file_server 3993 root 6u IPv4 32708 0t0 TCP *:8600 (LISTEN) file_server 3993 root 7u IPv4 32709 0t0 TCP 127.0.0.1:8601 (LISTEN) file_server 3993 root 8u IPv4 2344463 0t0 TCP 127.0.0.1:8600-\u003e127.0.0.1:49172 (ESTABLISHED) http_msg_server 3998 root 5u IPv4 32765 0t0 TCP *:8400 (LISTEN) http_msg_server 3998 root 7u IPv4 2344443 0t0 TCP 127.0.0.1:41640-\u003e127.0.0.1:10600 (ESTABLISHED) http_msg_server 3998 root 8u IPv4 2344444 0t0 TCP 127.0.0.1:41642-\u003e127.0.0.1:10600 (ESTABLISHED) http_msg_server 3998 root 9u IPv4 2344445 0t0 TCP 127.0.0.1:41644-\u003e127.0.0.1:10600 (ESTABLISHED) http_msg_server 3998 root 10u IPv4 2344446 0t0 TCP 127.0.0.1:41646-\u003e127.0.0.1:10600 (ESTABLISHED) http_msg_server 3998 root 11u IPv4 2344447 0t0 TCP 127.0.0.1:41648-\u003e127.0.0.1:10600 (ESTABLISHED) http_msg_server 3998 root 12u IPv4 2344448 0t0 TCP 127.0.0.1:41650-\u003e127.0.0.1:10600 (ESTABLISHED) http_msg_server 3998 root 13u IPv4 2344449 0t0 TCP 127.0.0.1:41652-\u003e127.0.0.1:10600 (ESTABLISHED) http_msg_server 3998 root 14u IPv4 2344450 0t0 TCP 127.0.0.1:41654-\u003e127.0.0.1:10600 (ESTABLISHED) http_msg_server 3998 root 15u IPv4 2344451 0t0 TCP 127.0.0.1:37566-\u003e127.0.0.1:8200 (ESTABLISHED) msg_server 4011 root 5u IPv4 32862 0t0 TCP *:8000 (LISTEN) msg_server 4011 root 7u IPv4 2344437 0t0 TCP 127.0.0.1:49172-\u003e127.0.0.1:8600 (ESTABLISHED) msg_server 4011 root 8u IPv4 2344438 0t0 TCP 127.0.0.1:41630-\u003e127.0.0.1:10600 (ESTABLISHED) msg_server 4011 root 9u IPv4 2344439 0t0 TCP 127.0.0.1:41632-\u003e127.0.0.1:10600 (ESTABLISHED) msg_server 4011 root 10u IPv4 2344440 0t0 TCP 127.0.0.1:47294-\u003e127.0.0.1:8100 (ESTABLISHED) msg_server 4011 root 11u IPv4 2344441 0t0 TCP 127.0.0.1:37546-\u003e127.0.0.1:8200 (ESTABLISHED) msg_server 4011 root 13u IPv4 2347252 0t0 TCP 192.168.226.128:8000-\u003e192.168.226.1:20801 (ESTABLISHED) push_server 4017 root 8u IPv4 32946 0t0 UDP 127.0.0.1:34870 route_server 4025 root 5u IPv4 32975 0t0 TCP *:8200 (LISTEN) route_server 4025 root 7u IPv4 2344467 0t0 TCP 127.0.0.1:8200-\u003e127.0.0.1:37546 (ESTABLISHED) route_server 4025 root 8u IPv4 2344468 0t0 TCP 127.0.0.1:8200-\u003e127.0.0.1:37566 (ESTABLISHED) msfs 4038 root 5u IPv4 33065 0t0 TCP 127.0.0.1:8700 (LISTEN) login_server 4075 root 5u IPv4 33115 0t0 TCP *:8008 (LISTEN) login_server 4075 root 7u IPv4 33116 0t0 TCP *:8100 (LISTEN) login_server 4075 root 8u IPv4 33117 0t0 TCP *:8080 (LISTEN) login_server 4075 root 9u IPv4 2344465 0t0 TCP 127.0.0.1:8100-\u003e127.0.0.1:47294 (ESTABLISHED) 服务之间的拓扑图如下：\n各端口号在上面了。\n现在我们用pc端来连接一下服务器，假如我们在用户表里面建立个账号叫test和zhangyl。\n将登录服务器的地址设置为msg_server的监听端口号，如上图所示。输入用户名和密码（密码随意）。\n这样就可以进行聊天了，当然我这里同一台机器上开了两个pc客户端。实际使用的时候一台机器是不允许开两个终端的，为了测试方便，你需要取消这个限制。用VS2013或以上版本打开win-client\\solution\\teamtalk.sln，修改如下代码取消pc客户端单例限制：在teamtalk.cpp的CteamtalkApp::InitInstance()中，\npc端主程序用的是mfc框架，界面使用的duilib库。 我们将在下一篇文章中详细介绍pc端程序源码。\n这篇关于服务器端的部署就到这里了，个人觉得很不详尽，因为后面关于服务器的架构分析时会再次详细地介绍这一块，所以这里写的就比较简单了。\n如果你在实际部署时遇到任何问题都可以加我微信 easy_coder 交流。\n",
  "wordCount" : "1903",
  "inLanguage": "en",
  "datePublished": "2021-01-11T09:20:42Z",
  "dateModified": "2021-01-11T09:20:42Z",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://haokiu.com/blog/23af895a60264bfe949c3636689d3f83/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "haokiu",
    "logo": {
      "@type": "ImageObject",
      "url": "https://haokiu.com/favicon.ico"
    }
  }
}
</script>
</head>

<body class="" id="top">
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.body.classList.add('dark');
    } else if (localStorage.getItem("pref-theme") === "light") {
        document.body.classList.remove('dark')
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.body.classList.add('dark');
    }

</script>

<header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://haokiu.com/" accesskey="h" title="haokiu (Alt + H)">haokiu</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://haokiu.com/" title="haokiu">
                    <span>Home</span>
                </a>
            </li>
            <li>
                <a href="https://haokiu.com/1/" title="1s">
                    <span>后端</span>
                </a>
            </li>
            <li>
                <a href="https://haokiu.com/2/" title="2s">
                    <span>前端</span>
                </a>
            </li>
            <li>
                <a href="https://haokiu.com/3/" title="3s">
                    <span>区块链</span>
                </a>
            </li>
            <li>
                <a href="https://haokiu.com/4/" title="4s">
                    <span>大数据</span>
                </a>
            </li>
            <li>
                <a href="https://haokiu.com/5/" title="5s">
                    <span>linux</span>
                </a>
            </li>
            <li>
                <a href="https://haokiu.com/6/" title="6s">
                    <span>其他</span>
                </a>
            </li>
            <li>
                <a href="https://haokiu.com/tags/" title="Tags">
                    <span>tags</span>
                </a>
            </li>
            <li>
                <a href="https://haokiu.com/categories/" title="Categories">
                    <span>categories</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    <div class="breadcrumbs"><a href="https://haokiu.com/">Home</a>&nbsp;»&nbsp;<a href="https://haokiu.com/1/">1s</a></div>
    <h1 class="post-title">
      02 服务器端的程序的编译与部署
    </h1>
    <div class="post-meta"><span title='2021-01-11 09:20:42 +0000 UTC'>January 11, 2021</span>

</div>
  </header> <div class="toc">
    <details  open>
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#02-%e6%9c%8d%e5%8a%a1%e5%99%a8%e7%ab%af%e7%9a%84%e7%a8%8b%e5%ba%8f%e7%9a%84%e7%bc%96%e8%af%91%e4%b8%8e%e9%83%a8%e7%bd%b2" aria-label="02 服务器端的程序的编译与部署">02 服务器端的程序的编译与部署</a>
                </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h1 id="02-服务器端的程序的编译与部署">02 服务器端的程序的编译与部署</h1>
<p>这篇我们来介绍下TeamTalk服务器端的编译与部署，部署文档在auto_setup下，这里我们只介绍下服务器程序的编译与部署，不包括管理后台的部署，其部署方法在auto_setup\im_server文件夹，其实按官方介绍只要找一台干净的linux系统运行一下auto_setup\im_server\setup.sh程序就可以了，会自动安装mysql（maridb，mysql被oracle收购后，分为两个分支，继续开源的分支改名叫maridb）、nginx和redis。我们暂且不部署web端，所以不需要安装nginx。我这里是手动安装了mysql和redis。然后启动mysql和redis，并手动建立如下库和表。库名叫teamtalk，需要建立以下这些表：</p>
<pre tabindex="0"><code>--后台管理员表
--password  密码,规则md5(md5(passwd)+salt)
CREATE TABLE `IMAdmin` (
  `id` mediumint(6) unsigned NOT NULL AUTO_INCREMENT,
  `uname` varchar(40) NOT NULL COMMENT &#39;用户名&#39;,
  `pwd` char(32) NOT NULL COMMENT &#39;经过md5加密的密码&#39;,
  `status` tinyint(2) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;用户状态 0 :正常 1:删除 可扩展&#39;,
  `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;,
  `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8

--存储语音地址
CREATE TABLE `IMAudio` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `fromId` int(11) unsigned NOT NULL COMMENT &#39;发送者Id&#39;,
  `toId` int(11) unsigned NOT NULL COMMENT &#39;接收者Id&#39;,
  `path` varchar(255) COLLATE utf8mb4_bin DEFAULT &#39;&#39; COMMENT &#39;语音存储的地址&#39;,
  `size` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;文件大小&#39;,
  `duration` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;语音时长&#39;,
  `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;,
  PRIMARY KEY (`id`),
  KEY `idx_fromId_toId` (`fromId`,`toId`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin

--存储部门信息
CREATE TABLE `IMDepart` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;部门id&#39;,
  `departName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;部门名称&#39;,
  `priority` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;显示优先级,相同优先级按拼音顺序排列&#39;,
  `parentId` int(11) unsigned NOT NULL COMMENT &#39;上级部门id&#39;,
  `status` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;状态&#39;,
  `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;,
  `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;,
  PRIMARY KEY (`id`),
  KEY `idx_departName` (`departName`),
  KEY `idx_priority_status` (`priority`,`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin

--发现配置表
CREATE TABLE `IMDiscovery` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;,
  `itemName` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;名称&#39;,
  `itemUrl` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;URL&#39;,
  `itemPriority` int(11) unsigned NOT NULL COMMENT &#39;显示优先级&#39;,
  `status` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;状态&#39;,
  `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;,
  `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;,
  PRIMARY KEY (`id`),
  KEY `idx_itemName` (`itemName`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin


--群组表
CREATE TABLE `IMGroup` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `name` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;群名称&#39;,
  `avatar` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;群头像&#39;,
  `creator` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建者用户id&#39;,
  `type` tinyint(3) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;群组类型，1-固定;2-临时群&#39;,
  `userCnt` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;成员人数&#39;,
  `status` tinyint(3) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;是否删除,0-正常，1-删除&#39;,
  `version` int(11) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;群版本号&#39;,
  `lastChated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;最后聊天时间&#39;,
  `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;,
  `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;,
  PRIMARY KEY (`id`),
  KEY `idx_name` (`name`(191)),
  KEY `idx_creator` (`creator`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT=&#39;IM群信息&#39;

--群成员表
CREATE TABLE `IMGroupMember` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `groupId` int(11) unsigned NOT NULL COMMENT &#39;群Id&#39;,
  `userId` int(11) unsigned NOT NULL COMMENT &#39;用户id&#39;,
  `status` tinyint(4) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;是否退出群，0-正常，1-已退出&#39;,
  `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;,
  `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;,
  PRIMARY KEY (`id`),
  KEY `idx_groupId_userId_status` (`groupId`,`userId`,`status`),
  KEY `idx_userId_status_updated` (`userId`,`status`,`updated`),
  KEY `idx_groupId_updated` (`groupId`,`updated`)
) ENGINE=InnoDB AUTO_INCREMENT=68 DEFAULT CHARSET=utf8 COMMENT=&#39;用户和群的关系表&#39;

--群消息表,x代表第几张表，目前做了分表有8张:0-7.消息具体在哪张表中，是groupId%IMGroupMessage表的数目
CREATE TABLE `IMGroupMessage_(x)` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `groupId` int(11) unsigned NOT NULL COMMENT &#39;用户的关系id&#39;,
  `userId` int(11) unsigned NOT NULL COMMENT &#39;发送用户的id&#39;,
  `msgId` int(11) unsigned NOT NULL COMMENT &#39;消息ID&#39;,
  `content` varchar(4096) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;消息内容&#39;,
  `type` tinyint(3) unsigned NOT NULL DEFAULT &#39;2&#39; COMMENT &#39;群消息类型,101为群语音,2为文本&#39;,
  `status` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;消息状态&#39;,
  `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;,
  `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;,
  PRIMARY KEY (`id`),
  KEY `idx_groupId_status_created` (`groupId`,`status`,`created`),
  KEY `idx_groupId_msgId_status_created` (`groupId`,`msgId`,`status`,`created`)  
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin COMMENT=&#39;IM群消息表&#39;

--消息表，x代表第几张表，目前做了分表有8张:0-7.具体在那张表，是relateId%IMMessage表数目.
CREATE TABLE `IMMessage_0` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `relateId` int(11) unsigned NOT NULL COMMENT &#39;用户的关系id&#39;,
  `fromId` int(11) unsigned NOT NULL COMMENT &#39;发送用户的id&#39;,
  `toId` int(11) unsigned NOT NULL COMMENT &#39;接收用户的id&#39;,
  `msgId` int(11) unsigned NOT NULL COMMENT &#39;消息ID&#39;,
  `content` varchar(4096) COLLATE utf8mb4_bin DEFAULT &#39;&#39; COMMENT &#39;消息内容&#39;,
  `type` tinyint(2) unsigned NOT NULL DEFAULT &#39;1&#39; COMMENT &#39;消息类型&#39;,
  `status` tinyint(1) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;0正常 1被删除&#39;,
  `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, 
  `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;,   PRIMARY KEY (`id`),
  KEY `idx_relateId_status_created` (`relateId`,`status`,`created`),
  KEY `idx_relateId_status_msgId_created` (`relateId`,`status`,`msgId`,`created`),
  KEY `idx_fromId_toId_created` (`fromId`,`toId`,`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin

--最近联系人(会话)表。
CREATE TABLE `IMRecentSession` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `userId` int(11) unsigned NOT NULL COMMENT &#39;用户id&#39;,
  `peerId` int(11) unsigned NOT NULL COMMENT &#39;对方id&#39;,
  `type` tinyint(1) unsigned DEFAULT &#39;0&#39; COMMENT &#39;类型，1-用户,2-群组&#39;,
  `status` tinyint(1) unsigned DEFAULT &#39;0&#39; COMMENT &#39;用户:0-正常, 1-用户A删除,群组:0-正常, 1-被删除&#39;,
  `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;,
  `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;,
  PRIMARY KEY (`id`),
  KEY `idx_userId_peerId_status_updated` (`userId`,`peerId`,`status`,`updated`),
  KEY `idx_userId_peerId_type` (`userId`,`peerId`,`type`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8

--用户关系表，标识两个用户之间的唯一关系id，用于消息分表。relationId % 消息表数目。
CREATE TABLE `IMRelationShip` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `smallId` int(11) unsigned NOT NULL COMMENT &#39;用户A的id&#39;,
  `bigId` int(11) unsigned NOT NULL COMMENT &#39;用户B的id&#39;,
  `status` tinyint(1) unsigned DEFAULT &#39;0&#39; COMMENT &#39;用户:0-正常, 1-用户A删除,群组:0-正常, 1-被删除&#39;,
  `created` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;创建时间&#39;,
  `updated` int(11) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;更新时间&#39;,
  PRIMARY KEY (`id`),
  KEY `idx_smallId_bigId_status_updated` (`smallId`,`bigId`,`status`,`updated`)  
) ENGINE=InnoDB DEFAULT CHARSET=utf8

--用户表
--password  密码,规则md5(md5(passwd)+salt)
CREATE TABLE `IMUser` (
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;用户id&#39;,
  `sex` tinyint(1) unsigned NOT NULL DEFAULT &#39;0&#39; COMMENT &#39;1男2女0未知&#39;,
  `name` varchar(32) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;用户名&#39;,
  `domain` varchar(32) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;拼音&#39;,
  `nick` varchar(32) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;花名,绰号等&#39;,
  `password` varchar(32) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;密码&#39;,
  `salt` varchar(4) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;混淆码&#39;,
  `phone` varchar(11) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;手机号码&#39;,
  `email` varchar(64) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;email&#39;,
  `avatar` varchar(255) COLLATE utf8mb4_bin DEFAULT &#39;&#39; COMMENT &#39;自定义用户头像&#39;,
  `departId` int(11) unsigned NOT NULL COMMENT &#39;所属部门Id&#39;,
  `status` tinyint(2) unsigned DEFAULT &#39;0&#39; COMMENT &#39;1. 试用期 2. 正式 3. 离职 4.实习&#39;,
  `sign_info` varchar(32) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;个性签名&#39;,
  `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;,
  `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;,
  PRIMARY KEY (`id`),
  KEY `idx_domain` (`domain`),
  KEY `idx_name` (`name`),
  KEY `idx_phone` (`phone`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin

--离线文件传输表（同事建议的，待考证）
CREATE TABLE `IMTransmitFile` ( 
  `id` int(11) unsigned NOT NULL AUTO_INCREMENT COMMENT &#39;id&#39;, 
  `fromId` int(11) unsigned NOT NULL COMMENT &#39;发送用户的id&#39;, 
  `toId` int(11) unsigned NOT NULL COMMENT &#39;接收用户的id&#39;,  
  `fileName` varchar(32) COLLATE utf8mb4_bin DEFAULT &#39;&#39; COMMENT &#39;文件名字&#39;, 
  `size` int(11) unsigned NOT NULL COMMENT &#39;文件大小&#39;, 
  `taskId` varchar(256) COLLATE utf8mb4_bin NOT NULL DEFAULT &#39;&#39; COMMENT &#39;任务id&#39;, 
  `status` tinyint(1) unsigned DEFAULT &#39;0&#39; COMMENT &#39;状态&#39;,  
  `created` int(11) unsigned NOT NULL COMMENT &#39;创建时间&#39;, 
  `updated` int(11) unsigned NOT NULL COMMENT &#39;更新时间&#39;, 
  PRIMARY KEY (`id`), 
  KEY `idx_taskId` (`taskId`) 
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_bin; 
</code></pre><p>因为这个企业内部的即时通讯软件，所以客户端不提供注册功能，要想增加新用户，必须通过在管理后台界面手动添加，这里由于我们目前没有部署管理后台界面（需要先安装nginx），所以我们就直接先在用户表IMUser里面添加几个测试用户吧。这个就是基本的sql语句了。但是由于这里用户密码的生成规则是：md5(md5(passwd)+salt)，而我们不知道salt到底是什么，这个现在不急，我们后面分析服务器代码时会介绍它。所以，我们就暂且在数据库里面随便写的密码，然后在程序里面修改代码，暂且不校验密码。修改的地方在这里：server\src\db_proxy_server\business\InterLogin.cpp的51行（CInterLoginStrategy::doLogin函数里面），将这个if语句注释掉：</p>
<p><img loading="lazy" src="http://haokiu.seaxiang.com/haokiu/b5cb1ba9dd7f75d4e0bad52c8a3760ef.png" alt=""  />
</p>
<p>接下来就是如何编译程序了：</p>
<p>编译程序需要用到cmake和make、gcc，由于程序用了部分C++11的东西，所以gcc的版本至少在4.7以上，我的部署环境是CentOS7、cmake 2.8，gcc 4.8.5。</p>
<p>编译方法：</p>
<p><strong>编译说明</strong>
编译环境
TeamTalk编译需要依赖一些最新的c++标准, 建议使用CentOS 7.0, 如果使用的是CentOS 6.x,需要将g++版本升至支持c++11特性,升级脚本可以使用自动安装脚本目录下的gcc_setup</p>
<p>第三方库
TeamTalk使用了许多第三方库，包括protobuf,hiredis,mariadb(mysql),log4cxx等等,在第一次编译TeamTalk之前,建议先执行目录下的：</p>
<pre tabindex="0"><code>protobuf: make_protobuf.sh 
hiredis: make_hiredis.sh
mariadb: make_mariadb.sh
log4cxx: make_log4cxx.sh
</code></pre><p>这些脚本执行完后会自动将头文件和库文件拷贝至指定的目录。如果你的机器上已经安装了相应的模块，可以不用执行相对应的脚本。</p>
<p>make_protobuf.sh会做以下工作：</p>
<ol>
<li>
<p>解压和编译protobuf目录下的protobuf-2.6.1.tar.gz文件，并在将编译后的文件拷贝到该目录，分别是bin、include和lib，还有一个protobuf-2.6.1是解压后的目录。protobuf目录结构如下：</p>
<pre tabindex="0"><code>.
|-- bin
|-- include
|-- lib
|-- protobuf-2.6.1
`-- protobuf-2.6.1.tar.gz
</code></pre></li>
<li>
<p>同时会往server/src/base/pb目录下拷贝google和lib两个文件夹，protocol是原来就存在的存放protobuf的*.proto文件的目录，目录结构如下：</p>
<pre tabindex="0"><code>.
|-- google
|-- lib
`-- protocol
</code></pre></li>
</ol>
<p>make_log4cxx.sh 会做以下工作：</p>
<p>\1. 从网址 <a href="http://mirror.bit.edu.cn/apache/logging/log4cxx/0.10.0/apache-log4cxx-0.10.0.tar.gz">http://mirror.bit.edu.cn/apache/logging/log4cxx/0.10.0/apache-log4cxx-0.10.0.tar.gz</a> 下载apache-log4cxx-0.10.0.tar.gz文件。下载好后解压安装，并在log4</p>
<p>cxx目录下生成lib和include两个文件夹，目录结构如下：</p>
<pre tabindex="0"><code>.
|-- apache-log4cxx-0.10.0
|-- apache-log4cxx-0.10.0.tar.gz
|-- console.cpp
|-- include
|-- inputstreamreader.cpp
|-- lib
`-- socketoutputstream.cpp
</code></pre><p>同样，apache-log4cxx-0.10.0是解压后的目录。</p>
<p>make_hiredis.sh和make_mariadb.sh原理一样，这里就不介绍了。</p>
<p><strong>编译TeamTalk服务器</strong>
当以上步骤都完成后，可以使用&quot;./build.sh version 1&quot;编译整个TeamTalk工程,一旦编译完成，会在上级目录生成im_server_x.tar.gz包，该压缩包包含的内容有:
sync_lib_for_zip.sh: 将lib目录下的依赖库copy至各个服务器的目录下，启动服务前需要先执行一次该脚本
lib: 主要包含各个服务器依赖的第三方库
restart.sh: 启动脚本，启动方式为./restart.sh msg_server</p>
<pre tabindex="0"><code>login_server:
msg_server:
route_server: 
db_proxy_server:
file_server:
push_server:
msfs:
</code></pre><p>也可以进入各个服务目录下手动使用cmake . &amp;&amp; make去逐个编译。每个程序都有个配置文件，配置文件在auto_setup\im_server\conf目录下，手动编译时，请考到与与对应服务相同的目录下。</p>
<p>注意最终生成的可执行文件，其配置文件必须和他们在同一个目录。另外可执行程序需要一个log4cxx.properties文件，这个文件是程序使用的日志库log4</p>
<p>cxx的配置文件，必须也和可执行程序在同一个目录。如果没有，程序仍然能运行，但可能不能正常工作。你可以将\server\src\slog\log4cxx.properties下的该文件拷贝过去。</p>
<p>生成程序后，你需要启动以上服务，当然在这前提下你必须能正常连接你的mysql和redis。可以按下列顺序启动服务：</p>
<pre tabindex="0"><code>db_proxy_server
file_server
msfs
route_server
http_server
login_server
msg_server
</code></pre><p>程序启动以后用lsof -i -Pn命令查看端口和连接情况：</p>
<pre tabindex="0"><code>mysqld      2970  mysql  18u  IPv6  26929    0t0  TCP *:3306 (LISTEN)
mysqld      2970  mysql  40u  IPv6 2347264    0t0  TCP 127.0.0.1:3306-&gt;127.0.0.1:34780 (ESTABLISHED)
mysqld      2970  mysql  41u  IPv6 2347266    0t0  TCP 127.0.0.1:3306-&gt;127.0.0.1:34782 (ESTABLISHED)
mysqld      2970  mysql  42u  IPv6  31596    0t0  TCP 127.0.0.1:3306-&gt;127.0.0.1:33954 (ESTABLISHED)
mysqld      2970  mysql  43u  IPv6  31598    0t0  TCP 127.0.0.1:3306-&gt;127.0.0.1:33956 (ESTABLISHED)
mysqld      2970  mysql  50u  IPv6  61604    0t0  TCP 127.0.0.1:3306-&gt;127.0.0.1:34638 (ESTABLISHED)
mysqld      2970  mysql  51u  IPv6  108460    0t0  TCP 127.0.0.1:3306-&gt;127.0.0.1:37204 (ESTABLISHED)
redis-server   3772 zhangyl   4u  IPv6  30711    0t0  TCP *:6379 (LISTEN)
redis-server   3772 zhangyl   5u  IPv4  30712    0t0  TCP *:6379 (LISTEN)
redis-server   3772 zhangyl   6u  IPv4  31560    0t0  TCP 127.0.0.1:6379-&gt;127.0.0.1:39540 (ESTABLISHED)
redis-server   3772 zhangyl   7u  IPv4  31563    0t0  TCP 127.0.0.1:6379-&gt;127.0.0.1:39542 (ESTABLISHED)
redis-server   3772 zhangyl   8u  IPv4  31566    0t0  TCP 127.0.0.1:6379-&gt;127.0.0.1:39544 (ESTABLISHED)
redis-server   3772 zhangyl   9u  IPv4  31569    0t0  TCP 127.0.0.1:6379-&gt;127.0.0.1:39546 (ESTABLISHED)
redis-server   3772 zhangyl  10u  IPv4  31572    0t0  TCP 127.0.0.1:6379-&gt;127.0.0.1:39548 (ESTABLISHED)
redis-server   3772 zhangyl  11u  IPv4  31575    0t0  TCP 127.0.0.1:6379-&gt;127.0.0.1:39550 (ESTABLISHED)
redis-server   3772 zhangyl  12u  IPv4  31578    0t0  TCP 127.0.0.1:6379-&gt;127.0.0.1:39552 (ESTABLISHED)
redis-server   3772 zhangyl  13u  IPv4  31581    0t0  TCP 127.0.0.1:6379-&gt;127.0.0.1:39554 (ESTABLISHED)
redis-server   3772 zhangyl  14u  IPv4  31584    0t0  TCP 127.0.0.1:6379-&gt;127.0.0.1:39556 (ESTABLISHED)
redis-server   3772 zhangyl  15u  IPv4  31587    0t0  TCP 127.0.0.1:6379-&gt;127.0.0.1:39558 (ESTABLISHED)
db_proxy_server 3930   root   5u  IPv4  31559    0t0  TCP 127.0.0.1:39540-&gt;127.0.0.1:6379 (ESTABLISHED)
db_proxy_server 3930   root   6u  IPv4  31562    0t0  TCP 127.0.0.1:39542-&gt;127.0.0.1:6379 (ESTABLISHED)
db_proxy_server 3930   root   7u  IPv4  31565    0t0  TCP 127.0.0.1:39544-&gt;127.0.0.1:6379 (ESTABLISHED)
db_proxy_server 3930   root   8u  IPv4  31568    0t0  TCP 127.0.0.1:39546-&gt;127.0.0.1:6379 (ESTABLISHED)
db_proxy_server 3930   root   9u  IPv4  31571    0t0  TCP 127.0.0.1:39548-&gt;127.0.0.1:6379 (ESTABLISHED)
db_proxy_server 3930   root  10u  IPv4  31574    0t0  TCP 127.0.0.1:39550-&gt;127.0.0.1:6379 (ESTABLISHED)
db_proxy_server 3930   root  11u  IPv4  31577    0t0  TCP 127.0.0.1:39552-&gt;127.0.0.1:6379 (ESTABLISHED)
db_proxy_server 3930   root  12u  IPv4  31580    0t0  TCP 127.0.0.1:39554-&gt;127.0.0.1:6379 (ESTABLISHED)
db_proxy_server 3930   root  13u  IPv4  31583    0t0  TCP 127.0.0.1:39556-&gt;127.0.0.1:6379 (ESTABLISHED)
db_proxy_server 3930   root  14u  IPv4  31586    0t0  TCP 127.0.0.1:39558-&gt;127.0.0.1:6379 (ESTABLISHED)
db_proxy_server 3930   root  15u  IPv4 2347263    0t0  TCP 127.0.0.1:34780-&gt;127.0.0.1:3306 (ESTABLISHED)
db_proxy_server 3930   root  16u  IPv4 2347265    0t0  TCP 127.0.0.1:34782-&gt;127.0.0.1:3306 (ESTABLISHED)
db_proxy_server 3930   root  17u  IPv4  31595    0t0  TCP 127.0.0.1:33954-&gt;127.0.0.1:3306 (ESTABLISHED)
db_proxy_server 3930   root  18u  IPv4  31597    0t0  TCP 127.0.0.1:33956-&gt;127.0.0.1:3306 (ESTABLISHED)
db_proxy_server 3930   root  20u  IPv4  31599    0t0  TCP *:10600 (LISTEN)
db_proxy_server 3930   root  21u  IPv4 2344452    0t0  TCP 127.0.0.1:10600-&gt;127.0.0.1:41630 (ESTABLISHED)
db_proxy_server 3930   root  22u  IPv4 2344453    0t0  TCP 127.0.0.1:10600-&gt;127.0.0.1:41632 (ESTABLISHED)
db_proxy_server 3930   root  23u  IPv4 2344454    0t0  TCP 127.0.0.1:10600-&gt;127.0.0.1:41640 (ESTABLISHED)
db_proxy_server 3930   root  24u  IPv4 2344455    0t0  TCP 127.0.0.1:10600-&gt;127.0.0.1:41642 (ESTABLISHED)
db_proxy_server 3930   root  25u  IPv4 2344456    0t0  TCP 127.0.0.1:10600-&gt;127.0.0.1:41644 (ESTABLISHED)
db_proxy_server 3930   root  26u  IPv4 2344457    0t0  TCP 127.0.0.1:10600-&gt;127.0.0.1:41646 (ESTABLISHED)
db_proxy_server 3930   root  27u  IPv4 2344458    0t0  TCP 127.0.0.1:10600-&gt;127.0.0.1:41648 (ESTABLISHED)
db_proxy_server 3930   root  28u  IPv4 2344459    0t0  TCP 127.0.0.1:10600-&gt;127.0.0.1:41650 (ESTABLISHED)
db_proxy_server 3930   root  29u  IPv4 2344460    0t0  TCP 127.0.0.1:10600-&gt;127.0.0.1:41652 (ESTABLISHED)
db_proxy_server 3930   root  30u  IPv4 2344461    0t0  TCP 127.0.0.1:10600-&gt;127.0.0.1:41654 (ESTABLISHED)
db_proxy_server 3930   root  31u  IPv4  61603    0t0  TCP 127.0.0.1:34638-&gt;127.0.0.1:3306 (ESTABLISHED)
db_proxy_server 3930   root  32u  IPv4  108459    0t0  TCP 127.0.0.1:37204-&gt;127.0.0.1:3306 (ESTABLISHED)
file_server   3993   root   6u  IPv4  32708    0t0  TCP *:8600 (LISTEN)
file_server   3993   root   7u  IPv4  32709    0t0  TCP 127.0.0.1:8601 (LISTEN)
file_server   3993   root   8u  IPv4 2344463    0t0  TCP 127.0.0.1:8600-&gt;127.0.0.1:49172 (ESTABLISHED)
http_msg_server 3998   root   5u  IPv4  32765    0t0  TCP *:8400 (LISTEN)
http_msg_server 3998   root   7u  IPv4 2344443    0t0  TCP 127.0.0.1:41640-&gt;127.0.0.1:10600 (ESTABLISHED)
http_msg_server 3998   root   8u  IPv4 2344444    0t0  TCP 127.0.0.1:41642-&gt;127.0.0.1:10600 (ESTABLISHED)
http_msg_server 3998   root   9u  IPv4 2344445    0t0  TCP 127.0.0.1:41644-&gt;127.0.0.1:10600 (ESTABLISHED)
http_msg_server 3998   root  10u  IPv4 2344446    0t0  TCP 127.0.0.1:41646-&gt;127.0.0.1:10600 (ESTABLISHED)
http_msg_server 3998   root  11u  IPv4 2344447    0t0  TCP 127.0.0.1:41648-&gt;127.0.0.1:10600 (ESTABLISHED)
http_msg_server 3998   root  12u  IPv4 2344448    0t0  TCP 127.0.0.1:41650-&gt;127.0.0.1:10600 (ESTABLISHED)
http_msg_server 3998   root  13u  IPv4 2344449    0t0  TCP 127.0.0.1:41652-&gt;127.0.0.1:10600 (ESTABLISHED)
http_msg_server 3998   root  14u  IPv4 2344450    0t0  TCP 127.0.0.1:41654-&gt;127.0.0.1:10600 (ESTABLISHED)
http_msg_server 3998   root  15u  IPv4 2344451    0t0  TCP 127.0.0.1:37566-&gt;127.0.0.1:8200 (ESTABLISHED)
msg_server    4011   root   5u  IPv4  32862    0t0  TCP *:8000 (LISTEN)
msg_server    4011   root   7u  IPv4 2344437    0t0  TCP 127.0.0.1:49172-&gt;127.0.0.1:8600 (ESTABLISHED)
msg_server    4011   root   8u  IPv4 2344438    0t0  TCP 127.0.0.1:41630-&gt;127.0.0.1:10600 (ESTABLISHED)
msg_server    4011   root   9u  IPv4 2344439    0t0  TCP 127.0.0.1:41632-&gt;127.0.0.1:10600 (ESTABLISHED)
msg_server    4011   root  10u  IPv4 2344440    0t0  TCP 127.0.0.1:47294-&gt;127.0.0.1:8100 (ESTABLISHED)
msg_server    4011   root  11u  IPv4 2344441    0t0  TCP 127.0.0.1:37546-&gt;127.0.0.1:8200 (ESTABLISHED)
msg_server    4011   root  13u  IPv4 2347252    0t0  TCP 192.168.226.128:8000-&gt;192.168.226.1:20801 (ESTABLISHED)
push_server   4017   root   8u  IPv4  32946    0t0  UDP 127.0.0.1:34870 
route_server   4025   root   5u  IPv4  32975    0t0  TCP *:8200 (LISTEN)
route_server   4025   root   7u  IPv4 2344467    0t0  TCP 127.0.0.1:8200-&gt;127.0.0.1:37546 (ESTABLISHED)
route_server   4025   root   8u  IPv4 2344468    0t0  TCP 127.0.0.1:8200-&gt;127.0.0.1:37566 (ESTABLISHED)
msfs       4038   root   5u  IPv4  33065    0t0  TCP 127.0.0.1:8700 (LISTEN)
login_server   4075   root   5u  IPv4  33115    0t0  TCP *:8008 (LISTEN)
login_server   4075   root   7u  IPv4  33116    0t0  TCP *:8100 (LISTEN)
login_server   4075   root   8u  IPv4  33117    0t0  TCP *:8080 (LISTEN)
login_server   4075   root   9u  IPv4 2344465    0t0  TCP 127.0.0.1:8100-&gt;127.0.0.1:47294 (ESTABLISHED)
</code></pre><p>服务之间的拓扑图如下：</p>
<p><img loading="lazy" src="http://haokiu.seaxiang.com/haokiu/5190ae189b8604e2ef5da9349c81ec32.png" alt=""  />
</p>
<p>各端口号在上面了。</p>
<p>现在我们用pc端来连接一下服务器，假如我们在用户表里面建立个账号叫test和zhangyl。</p>
<p><img loading="lazy" src="http://haokiu.seaxiang.com/haokiu/dfad4828b78437325115b42ce99a4b47.png" alt=""  />
</p>
<p>将登录服务器的地址设置为msg_server的监听端口号，如上图所示。输入用户名和密码（密码随意）。</p>
<p><img loading="lazy" src="http://haokiu.seaxiang.com/haokiu/f3cf6f95ad7bb9cd392984a7cb11be42.png" alt=""  />
</p>
<p>这样就可以进行聊天了，当然我这里同一台机器上开了两个pc客户端。实际使用的时候一台机器是不允许开两个终端的，为了测试方便，你需要取消这个限制。用VS2013或以上版本打开win-client\solution\teamtalk.sln，修改如下代码取消pc客户端单例限制：在teamtalk.cpp的CteamtalkApp::InitInstance()中，</p>
<p><img loading="lazy" src="http://haokiu.seaxiang.com/haokiu/8d274b11f14214ae43487099c3d695cb.png" alt=""  />
</p>
<p>pc端主程序用的是mfc框架，界面使用的duilib库。 我们将在下一篇文章中详细介绍pc端程序源码。</p>
<p>这篇关于服务器端的部署就到这里了，个人觉得很不详尽，因为后面关于服务器的架构分析时会再次详细地介绍这一块，所以这里写的就比较简单了。</p>
<p>如果你在实际部署时遇到任何问题都可以加我微信 easy_coder 交流。</p>

  </div>

  <footer class="post-footer">
    <ul class="post-tags">
    </ul>
<nav class="paginav">
  <a class="prev" href="https://haokiu.com/blog/8c53924ed21041948dff215384cdb81d/">
    <span class="title">« Prev</span>
    <br>
    <span>01 TeamTalk介绍</span>
  </a>
  <a class="next" href="https://haokiu.com/blog/74f8790b79af42ab856a668b8927b38a/">
    <span class="title">Next »</span>
    <br>
    <span>03 服务器端的程序架构介绍</span>
  </a>
</nav>

  </footer>
</article>
    </main>
    
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu')
    if (menu) {
        menu.scrollLeft = localStorage.getItem("menu-scroll-position");
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        if (document.body.className.includes("dark")) {
            document.body.classList.remove('dark');
            localStorage.setItem("pref-theme", 'light');
        } else {
            document.body.classList.add('dark');
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
